(()=>{"use strict";(()=>{const e=(e,t,o,n,r)=>{const d=new XMLHttpRequest;d.responseType="json",d.timeout=1e3,d.addEventListener("load",(function(){200===d.status?n(d.response):r("Статус ответа: "+d.status+" "+d.statusText)})),d.addEventListener("error",(function(){r("Произошла ошибка соединения")})),d.addEventListener("timeout",(function(){r("Запрос не успел выполниться за "+d.timeout+"мс")})),d.open(e,t),d.send(o)};window.server={load:(t,o)=>{e("GET","https://21.javascript.pages.academy/keksobooking/data",null,t,o)},upload:(t,o,n)=>{e("POST","https://21.javascript.pages.academy/keksobooking",t,o,n)}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".popup"),t=document.querySelector(".map__filters-container"),o={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},n=e=>{e.remove(),e.removeEventListener("click",n),document.removeEventListener("keydown",n)};window.card={renderPopupFragment:r=>{t.before((t=>{const r=e.cloneNode(!0);r.querySelector(".popup__title").textContent=t.offer.title,r.querySelector(".popup__text--address").textContent=t.offer.address,r.querySelector(".popup__text--price").textContent=t.offer.price+" ₽/ночь",r.querySelector(".popup__type").textContent=o[t.offer.type],r.querySelector(".popup__text--capacity").textContent=`${t.offer.rooms} комнаты для ${t.offer.guests} гостей`,r.querySelector(".popup__text--time").textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`,r.querySelector(".popup__close").addEventListener("click",(()=>{n(r)})),document.addEventListener("keydown",(e=>{27===e.keyCode&&n(r)}));const d=r.querySelectorAll(".popup__feature");for(let e=0;e<d.length;e++){const o=d[e],n=e=>o.classList.contains("popup__feature--"+e);t.offer.features.some(n)||o.classList.add("visually-hidden")}r.querySelector(".popup__description").textContent=t.offer.description,r.querySelector(".popup__avatar").src=t.author.avatar;const c=r.querySelector(".popup__photos"),s=r.querySelector(".popup__photo"),a=document.createDocumentFragment();return t.offer.photos.forEach((e=>{const t=s.cloneNode(!0);t.src=e,t.style.width="45",t.style.height="40",t.alt="Фотография жилья",a.appendChild(t)})),c.innerHTML="",c.appendChild(a),r})(r))},closeAllPopups:()=>{document.querySelectorAll(".popup").forEach((e=>{e.remove()}))}}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=document.querySelector(".map"),n=e=>{const o=e.location.x+25,n=e.location.y+35,r=t.cloneNode(!0),d=r.querySelector("img");return r.id=e.id,r.style=`left: ${o}px; top: ${n}px;`,d.src=e.author.avatar,d.alt=e.offer.title,r},r=(e,t)=>{window.card.closeAllPopups(),(e=>{const t=e.target.closest(".map__pin"),o=window.form.getPinsData().find((e=>e.id===t.id)),n=document.querySelector(".map__pin--active");n&&n.classList.remove("map__pin--active"),t.classList.contains("map__pin--active")||t.classList.add("map__pin--active"),window.card.renderPopupFragment(o)})(e),t.removeEventListener("click",r),t.removeEventListener("keydown",r)};window.pin={renderPins:t=>{const o=document.createElement("div");o.classList.add("pins");const d=t.length<5?t.length:5;for(let e=0;e<d;e++){let d=n(t[e]);d.addEventListener("click",(e=>{r(e,d)})),d.addEventListener("keydown",(e=>{13===e.keyCode&&r(e,d)})),o.appendChild(d)}const c=e.querySelector(".pins");c&&c.remove(),e.appendChild(o)},errorPinHandler:e=>{let t=document.createElement("div");t.classList.add("map__error-server"),t.textContent=e,o.insertAdjacentElement("afterbegin",t)}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e=document.querySelector(".ad-form"),t=document.querySelector("#address"),o=document.querySelector(".map"),n=document.querySelector(".map__filters"),r=document.querySelector(".map__pin--main"),d=e.querySelector("#title"),c=e.querySelector("#room_number"),s=e.querySelector("#capacity"),a=e.querySelector("#price"),l=e.querySelector("#type"),i=e.querySelector("#timein"),u=e.querySelector("#timeout"),p=document.querySelector(".ad-form__reset"),m=document.querySelector(".map__overlay"),v=document.querySelector("#success").content.querySelector(".success"),y=document.querySelector("#error").content.querySelector(".error"),f=document.querySelector("main"),h=e.querySelectorAll("fieldset"),_=document.querySelector(".error__button"),L={palace:{min:1e4,placeholder:"10000"},flat:{min:1e3,placeholder:"1000"},house:{min:5e3,placeholder:"5000"},bungalow:{min:0,placeholder:"0"}},q=()=>{for(let e of h)e.disabled=!0};let S=[];const g=e=>{S=e,S=e.map(((e,t)=>(e.id=""+t,e))),window.pin.renderPins(S),n.classList.remove("map__filters--disabled")},w=()=>{(()=>{for(let e of h)e.disabled=!1})(),o.classList.remove("map--faded"),e.classList.remove("ad-form--disabled"),0===S.length?window.server.load(g,window.pin.errorPinHandler):(n.classList.remove("map__filters--disabled"),window.pin.renderPins(S))},E=()=>{const e=parseInt(s.value,10),t=parseInt(c.value,10),o=t<e||0===e&&t<100?"Недопустимое количество комнат":"";c.setCustomValidity(o),c.reportValidity(),c.removeEventListener("change",E),s.removeEventListener("change",E)},k=()=>{a.placeholder=L[l.value].placeholder,a.min=L[l.value].min;const e=a.value.length<a.min?"Минимальная стоимость должна составлять "+a.min:"";a.setCustomValidity(e),a.reportValidity(),l.removeEventListener("change",k)},C=()=>{const e=parseInt(a.value,10)>1e6?"Максимальная стоимость должна составлять 1000000":"";a.setCustomValidity(e),a.reportValidity(),a.removeEventListener("input",C)},x=()=>{u.value=i.value,i.removeEventListener("change",x)},b=()=>{i.value=u.value,u.removeEventListener("change",b)},P=()=>{o.classList.add("map--faded"),e.classList.add("ad-form--disabled"),n.classList.add("map__filters--disabled"),t.value="570, 375",document.querySelector(".pins").remove(),document.querySelector(".popup")&&document.querySelector(".popup").remove()},A=()=>{document.querySelector(".succeded-form").remove(),document.removeEventListener("click",A),document.removeEventListener("keydown",A)},D=()=>{(()=>{const e=document.createElement("div"),t=v.cloneNode(!0);e.appendChild(t),e.classList.add("succeded-form"),f.insertAdjacentElement("afterbegin",e)})(),document.addEventListener("click",A),document.addEventListener("keydown",(e=>{27===e.keyCode&&A()})),e.reset(),P(),q()},V=()=>{document.querySelector(".error-form").remove(),document.removeEventListener("click",A),document.removeEventListener("keydown",A),_.removeEventListener("keydown",A)},$=()=>{(()=>{const e=document.createElement("div"),t=y.cloneNode(!0);e.appendChild(t),e.classList.add("error-form"),f.insertAdjacentElement("afterbegin",e)})(),document.addEventListener("click",V),document.addEventListener("keydown",(e=>{27===e.keyCode&&V()})),_.addEventListener("click",V)},j=(e,o)=>{e.preventDefault();let n=o.x-e.clientX,d=o.y-e.clientY;o={x:e.clientX,y:e.clientY};const c=(s=r.offsetTop-d)<130?130:s>630?630:s;var s;const a=(l=r.offsetLeft-n)>(i=m).offsetWidth-38?i.offsetWidth-38:l<0?-28:l;var l,i;r.style.top=c+"px",r.style.left=a+"px",t.value=`${c+33}, ${a+84}`},T=(e,t)=>{e.preventDefault(),j(e,t),document.removeEventListener("mousemove",j),document.removeEventListener("mouseup",T)};r.addEventListener("mousedown",(e=>{e.preventDefault(),0===e.button&&(w(),document.addEventListener("mousemove",(e=>{j(e,startCoords)})),document.addEventListener("mouseup",(e=>{T(e,startCoords)})))})),r.addEventListener("keydown",(e=>{13===e.keyCode&&w()})),d.addEventListener("input",(()=>{const e=d.value.length;e<30?(d.setCustomValidity(`Еще ${30-e} символов`),d.classList.add("wrong-input")):e>100?d.setCustomValidity(`Удалите лишние ${e-100} симв.`):d.setCustomValidity(""),d.reportValidity()})),c.addEventListener("change",(()=>{E()})),s.addEventListener("change",(()=>{E()})),l.addEventListener("change",(()=>{k()})),a.addEventListener("input",(()=>{C()})),i.addEventListener("change",(()=>{x()})),u.addEventListener("change",(()=>{b()})),p.addEventListener("click",(t=>{t.preventDefault(),e.reset(),P()})),e.addEventListener("submit",(t=>{t.preventDefault(),E(),e.checkValidity()&&window.server.upload(new FormData(e),D,$)})),q(),t.readOnly=!0,t.value="570, 375",window.form={getPinsData:()=>S}})(),(()=>{let e=["gif","jpg","jpeg","png"];const t=document.querySelector(".ad-form-header__input"),o=document.querySelector(".ad-form__input"),n=document.querySelector(".ad-form-header__preview img"),r=document.querySelector(".ad-form__photo");r.style.padding="15px 15px";const d=(e,t,o)=>{let n=e.files[0];const r=n.name.toLowerCase();if(t.some((e=>r.endsWith(e)))){let e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result})),e.readAsDataURL(n)}},c=t=>{let n=new Image(40,40);n.src="",t.appendChild(n),d(o,e,n)};t.addEventListener("change",(()=>{d(t,e,n)})),o.addEventListener("change",(()=>{if(r.querySelector("img")){const e=r.cloneNode();c(e),document.querySelector(".ad-form__photo-container").appendChild(e)}else c(r)}))})(),(()=>{const e="any",t=document.querySelector(".map__filters"),o=t.querySelector("#housing-type"),n=t.querySelector("#housing-price"),r=t.querySelector("#housing-rooms"),d=t.querySelector("#housing-guests"),c=t.querySelector("#housing-features"),s=t.children,a=e=>(()=>{const e=c.querySelectorAll("input");let t=[];for(let o=0;o<e.length;o++)e[o].checked&&t.push(e[o].value);return t})().every((t=>e.offer.features.includes(t)))?e:null,l=t=>{const n=o.value;return n===e||t.offer.type===n?t:null},i=t=>{const o=n.value;return o===e||((r=t.offer.price)<1e4?"low":r>5e4?"high":"middle")===o?t:null;var r},u=t=>{const o=r.value;return o===e||(1===(n=t.offer.rooms)?"1":2===n?"2":"3")===o?t:null;var n},p=e=>{const t=d.value;return"any"===t||(1===(o=e.offer.guests)?"1":2===o?"2":"0")===t?e:null;var o},m=window.debounce(window.pin.renderPins);for(let e=0;e<s.length;e++)s[e].addEventListener("change",(()=>{const e=window.form.getPinsData(),t=[l,i,u,p,a],o=[];for(let n=0;n<e.length&&o.length<5;n++){let r=e[n];for(let e=0;e<t.length&&r;e++)r=t[e](r);r&&o.push(r)}m(o),window.card.closeAllPopups()}))})()})();