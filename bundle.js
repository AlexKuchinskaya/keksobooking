(()=>{"use strict";(()=>{const e=(e,t,o,r,n)=>{const d=new XMLHttpRequest;d.responseType="json",d.timeout=1e3,d.addEventListener("load",(function(){200===d.status?r(d.response):n("Статус ответа: "+d.status+" "+d.statusText)})),d.addEventListener("error",(function(){n("Произошла ошибка соединения")})),d.addEventListener("timeout",(function(){n("Запрос не успел выполниться за "+d.timeout+"мс")})),d.open(e,t),d.send(o)};window.server={load:(t,o)=>{e("GET","https://21.javascript.pages.academy/keksobooking/data",null,t,o)},upload:(t,o,r)=>{e("POST","https://21.javascript.pages.academy/keksobooking",t,o,r)}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".popup"),t=document.querySelector(".map__filters-container"),o={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"};window.card={renderPopupFragment:r=>{t.before((t=>{const r=e.cloneNode(!0);r.querySelector(".popup__title").textContent=t.offer.title,r.querySelector(".popup__text--address").textContent=t.offer.address,r.querySelector(".popup__text--price").textContent=t.offer.price+" ₽/ночь",r.querySelector(".popup__type").textContent=o[t.offer.type],r.querySelector(".popup__text--capacity").textContent=`${t.offer.rooms} комнаты для ${t.offer.guests} гостей`,r.querySelector(".popup__text--time").textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`,r.querySelector(".popup__close").addEventListener("click",(()=>{r.remove()}));const n=e=>{27===e.keyCode&&(r.remove(),document.removeEventListener("keydown",n))};var d;document.addEventListener("keydown",n),d=t,r.querySelectorAll(".popup__feature").forEach((e=>{d.offer.features.some((t=>e.classList.contains("popup__feature--"+t)))||e.classList.add("visually-hidden")})),r.querySelector(".popup__description").textContent=t.offer.description,r.querySelector(".popup__avatar").src=t.author.avatar;const c=r.querySelector(".popup__photo"),s=r.querySelector(".popup__photos");return s.innerHTML="",t.offer.photos.forEach((e=>{const t=((e,t)=>{const o=t.cloneNode(!0);return o.src=e,o.style.width="45",o.style.height="40",o.alt="Фотография жилья",o})(e,c);s.appendChild(t)})),r})(r))},closeAllPopups:()=>{document.querySelectorAll(".popup").forEach((e=>{e.remove()}))}}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=document.querySelector(".map"),r=e=>{const o=e.location.x+25,r=e.location.y+35,n=t.cloneNode(!0),d=n.querySelector("img");return n.id=e.id,n.style=`left: ${o}px; top: ${r}px;`,d.src=e.author.avatar,d.alt=e.offer.title,n},n=e=>{window.card.closeAllPopups(),(e=>{const t=e.target.closest(".map__pin"),o=window.form.getPinsData().find((e=>e.id===t.id)),r=document.querySelector(".map__pin--active");r&&r.classList.remove("map__pin--active"),t.classList.contains("map__pin--active")||t.classList.add("map__pin--active"),window.card.renderPopupFragment(o)})(e)};window.pin={renderPins:t=>{const o=document.createElement("div");o.classList.add("pins");const d=t.length<5?t.length:5;for(let e=0;e<d;e++){let d=r(t[e]);d.addEventListener("click",(e=>{n(e)})),d.addEventListener("keydown",(e=>{13===e.keyCode&&n(e)})),o.appendChild(d)}const c=e.querySelector(".pins");c&&c.remove(),e.appendChild(o)},errorPinHandler:e=>{let t=document.createElement("div");t.classList.add("map__error-server"),t.textContent=e,o.insertAdjacentElement("afterbegin",t)}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e=document.querySelector(".ad-form"),t=document.querySelector("#address"),o=document.querySelector(".map"),r=document.querySelector(".map__filters"),n=document.querySelector(".map__pin--main"),d=e.querySelector("#title"),c=e.querySelector("#room_number"),s=e.querySelector("#capacity"),a=e.querySelector("#price"),l=e.querySelector("#type"),i=e.querySelector("#timein"),u=e.querySelector("#timeout"),p=document.querySelector(".ad-form__reset"),m=document.querySelector(".map__overlay"),y=document.querySelector("#success").content.querySelector(".success"),f=document.querySelector("#error").content.querySelector(".error"),v=document.querySelector("main"),_=e.querySelectorAll("fieldset"),h={palace:{min:1e4,placeholder:"10000"},flat:{min:1e3,placeholder:"1000"},house:{min:5e3,placeholder:"5000"},bungalow:{min:0,placeholder:"0"}},q={x:0,y:0},S=()=>{for(let e of _)e.disabled=!0};let w=[];const L=e=>{w=e,w=e.map(((e,t)=>(e.id=""+t,e))),window.pin.renderPins(w),r.classList.remove("map__filters--disabled")},g=()=>{(()=>{for(let e of _)e.disabled=!1})(),o.classList.remove("map--faded"),e.classList.remove("ad-form--disabled"),0===w.length?window.server.load(L,window.pin.errorPinHandler):(r.classList.remove("map__filters--disabled"),window.pin.renderPins(w))},E=()=>{const e=parseInt(s.value,10),t=parseInt(c.value,10),o=t<e||0===e&&t<100?"Недопустимое количество комнат":"";c.setCustomValidity(o),c.reportValidity()},k=()=>{o.classList.add("map--faded"),e.classList.add("ad-form--disabled"),r.classList.add("map__filters--disabled"),t.value="570, 375",document.querySelector(".pins").remove();const n=document.querySelector(".popup");n&&n.remove()},C=()=>{document.querySelector(".succeded-form").remove(),document.removeEventListener("click",x),document.removeEventListener("keydown",b)},x=()=>{C()},b=e=>{27===e.keyCode&&C()},P=()=>{(()=>{const e=document.createElement("div"),t=y.cloneNode(!0);e.appendChild(t),e.classList.add("succeded-form"),v.insertAdjacentElement("afterbegin",e)})(),document.addEventListener("click",x),document.addEventListener("keydown",b),e.reset(),k(),S()},A=()=>{document.querySelector(".error-form").remove(),document.removeEventListener("click",V),document.removeEventListener("keydown",D)},V=()=>{A()},D=e=>{27===e.keyCode&&A()},$=()=>{(()=>{const e=document.createElement("div"),t=f.cloneNode(!0);e.appendChild(t),e.classList.add("error-form"),v.insertAdjacentElement("afterbegin",e)})(),document.addEventListener("click",V),document.addEventListener("keydown",D)},j=e=>{e.preventDefault();const o=q.x-e.clientX,r=q.y-e.clientY;q.x=e.clientX,q.y=e.clientY;const d=(c=n.offsetTop-r)<130?130:c>630?630:c;var c;const s=(a=n.offsetLeft-o)>(l=m).offsetWidth-38?l.offsetWidth-38:a<0?-28:a;var a,l;n.style.top=d+"px",n.style.left=s+"px",t.value=`${d+33}, ${s+84}`},T=e=>{e.preventDefault(),j(e),document.removeEventListener("mousemove",j),document.removeEventListener("mouseup",T)};n.addEventListener("mousedown",(e=>{e.preventDefault(),0===e.button&&(g(),q.x=e.clientX,q.y=e.clientY,document.addEventListener("mousemove",j),document.addEventListener("mouseup",T))})),n.addEventListener("keydown",(e=>{13===e.keyCode&&g()})),d.addEventListener("input",(()=>{(()=>{const e=d.value.length;e<30?(d.setCustomValidity(`Еще ${30-e} символов`),d.classList.add("wrong-input")):e>100?d.setCustomValidity(`Удалите лишние ${e-100} симв.`):d.setCustomValidity(""),d.reportValidity()})()})),c.addEventListener("change",(()=>{E()})),s.addEventListener("change",(()=>{E()})),l.addEventListener("change",(()=>{(()=>{a.placeholder=h[l.value].placeholder,a.min=h[l.value].min;const e=a.value.length<a.min?"Минимальная стоимость должна составлять "+a.min:"";a.setCustomValidity(e),a.reportValidity()})()})),a.addEventListener("input",(()=>{(()=>{const e=parseInt(a.value,10)>1e6?"Максимальная стоимость должна составлять 1000000":"";a.setCustomValidity(e),a.reportValidity()})()})),i.addEventListener("change",(()=>{u.value=i.value})),u.addEventListener("change",(()=>{i.value=u.value})),p.addEventListener("click",(t=>{t.preventDefault(),e.reset(),k()})),e.addEventListener("submit",(t=>{t.preventDefault(),E(),e.checkValidity()&&window.server.upload(new FormData(e),P,$)})),S(),t.readOnly=!0,t.value="570, 375",window.form={getPinsData:()=>w}})(),(()=>{let e=["gif","jpg","jpeg","png"];const t=document.querySelector(".ad-form-header__input"),o=document.querySelector(".ad-form__input"),r=document.querySelector(".ad-form-header__preview img"),n=document.querySelector(".ad-form__photo");n.style.padding="15px 15px";const d=(e,t,o)=>{let r=e.files[0];const n=r.name.toLowerCase();if(t.some((e=>n.endsWith(e)))){let e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result})),e.readAsDataURL(r)}},c=t=>{let r=new Image(40,40);r.src="",t.appendChild(r),d(o,e,r)};t.addEventListener("change",(()=>{d(t,e,r)})),o.addEventListener("change",(()=>{if(n.querySelector("img")){const e=n.cloneNode();c(e),document.querySelector(".ad-form__photo-container").appendChild(e)}else c(n)}))})(),(()=>{const e="any",t=document.querySelector(".map__filters"),o=t.querySelector("#housing-type"),r=t.querySelector("#housing-price"),n=t.querySelector("#housing-rooms"),d=t.querySelector("#housing-guests"),c=t.querySelector("#housing-features"),s=t.querySelectorAll(".map__filter, .map__features"),a=e=>{const t=c.querySelectorAll("input:checked");return Array.from(t).every((t=>e.offer.features.includes(t.value)))?e:null},l=t=>{const r=o.value;return r===e||t.offer.type===r?t:null},i=t=>{const o=r.value;return o===e||((n=t.offer.price)<1e4?"low":n>5e4?"high":"middle")===o?t:null;var n},u=t=>{const o=n.value;return o===e||(1===(r=t.offer.rooms)?"1":2===r?"2":"3")===o?t:null;var r},p=e=>{const t=d.value;return"any"===t||(1===(o=e.offer.guests)?"1":2===o?"2":"0")===t?e:null;var o},m=window.debounce(window.pin.renderPins);s.forEach((e=>{e.addEventListener("change",(()=>{const e=window.form.getPinsData(),t=[l,i,u,p,a],o=[];for(let r=0;r<e.length&&o.length<5;r++){let n=e[r];for(let e=0;e<t.length&&n;e++)n=t[e](n);n&&o.push(n)}m(o),window.card.closeAllPopups()}))}))})()})();